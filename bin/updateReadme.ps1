#Requires -Version 7.0

param(
    [Switch] $Push
)

$dir = Resolve-Path "$PSScriptRoot\.."
$url = 'https://github.com/jat001/scoop-ox/tree/master/bucket'

$search = '<!-- Generated by bin\updateReadme.ps1, do not edid it manually. -->'
$text = "$search
Name | Description | Version | License
--- | --- | --- | ---
"

Import-Module "$PSScriptRoot\..\scripts\NaturalSort.psm1"

SortNaturally (Get-ChildItem "$dir\bucket") | ForEach-Object -Process {
    $name = ($_.Name -Split '.', -2, 'SimpleMatch')[0]
    $data = Get-Content $_.FullName | ConvertFrom-Json
    $text += "[$name]($($data.homepage)) | $($data.description) | [$($data.version)]($url/$($_.Name)) | [$($data.license.identifier)]($($data.license.url))`r`n"
}

Remove-Module -Name NaturalSort

$text += "$search"

$orig = Get-Content "$dir\README.md" -Raw

$search = [Regex]::Escape($search)
$text = $orig -Replace "(?s)$search.*?$search", $text

$text | Out-File "$dir\README.md" -NoNewline

if (-not $Push) { exit }

$git = {
    git -C "$dir" @args
    if (-not $?) { exit 1 }
}
&$git add README.md
&$git commit -m 'Update apps list on readme'
&$git push origin master
